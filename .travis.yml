language: php
services:
  - mysql
php:
  - 7.2
sudo: enabled
dist: xenial
before_install:
  - echo "==========================================================="
  - echo "Upgrade linux packages"
  - echo "==========================================================="
  - sudo sed -i 's|http://us-east-1.ec2.archive.ubuntu.com|https://ubuntu.mirror.noc.one|g' /etc/apt/sources.list
  - sudo sed -i 's|http://security.ubuntu.com|https://ubuntu.mirror.noc.one|g' /etc/apt/sources.list
  - sudo sed -i 's|http://us-central1.gce.archive.ubuntu.com|https://ubuntu.mirror.noc.one|g' /etc/apt/sources.list
  - sudo sed -i 's|http://ppa.launchpad.net|https://launchpad.proxy.noc.one|g' /etc/apt/sources.list.d/*.list
  - curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
  - sudo apt clean all && sudo apt -qq -y update
  - sudo apt install -y nodejs
  - echo "==========================================================="
  - echo "Configure MySQL"
  - echo "==========================================================="
  - sudo mysql -e "CREATE DATABASE sspanel; use sspanel; source sql/glzjin_all.sql;"
install:
  - npm i -g phplint
  - sudo chmod -R 755 *
  - composer install
  - cd uim-index-dev
  - npm i
  - cd ..
before_script:
  - cd uim-index-dev
  - npm run lint
  - npm run build
  - cd ..
  - phplint '**/*.php' '!vendor/**'
script:
  - cp config/.config.example.php config/.config.php
  - sed -i "s|$System_Config['db_password'] = 'sspanel';|$System_Config['db_password'] = '';|g" config/.config.php
  - php xcat createAdmin test@example.com test
  - php xcat syncusers
  - php xcat initdownload
  - php xcat initQQWry
  - nohup php -S 0.0.0.0:8080 -t public &
  - curl -o /dev/null -s -m 10 --connect-timeout 5 -w %{http_code} 'http://localhost:8080'

cache:
  directories:
    - uim-index-dev/node_modules
    - $HOME/.composer/cache/files
